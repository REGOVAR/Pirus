<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pirus</title>


    <!-- Base -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-migrate-3.0.0.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <!-- Datagrid -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.12/css/dataTables.bootstrap.min.css"/>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.12/js/dataTables.bootstrap.min.js"></script>
    <!-- Treegrid -->
    <link rel="stylesheet" href="/assets/treegrid/css/jquery.treegrid.css">
    <script type="text/javascript" src="/assets/treegrid/js/jquery.treegrid.js"></script>
    <script type="text/javascript" src="/assets/treegrid/js/jquery.treegrid.bootstrap3.js"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


    <!-- Form generator -->
    <link rel="stylesheet" href='/assets/brutusin/css/brutusin-json-forms.min.css'/>
    <script src="/assets/brutusin/js/brutusin-json-forms.min.js"></script>


    <!-- Pirus specific -->
    <link rel="stylesheet" href="/assets/pirus.css"/>
    <link rel="stylesheet" href="/assets/font-awesome-4.6.3/css/font-awesome.min.css"/>

</head>
<body>
    <div style="position: fixed; top:0; left:0; z-index:2000;">
        <img src="/assets/img/logo.png" width="100px" />
    </div>

    <nav class="navbar navbar-default navbar-fixed-top navbar-inverse">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>
            <div id="navbar" class="navbar-collapse collapse" aria-expanded="false" style="height: 1px;">
                <ul class="nav navbar-nav">
                    <li class="active"><a data-toggle="tab" href="#overview"><i class="fa fa-bar-chart" aria-hidden="true"></i> Overview</a></li>
                    <li><a data-toggle="tab" href="#files"><i class="fa fa-file-o" aria-hidden="true"></i> Files</a></li>
                    <li><a data-toggle="tab" href="#pipes"><i class="fa fa-puzzle-piece" aria-hidden="true"></i> Pipelines</a></li>
                    <li><a data-toggle="tab" href="#runs"><i class="fa fa-tasks" aria-hidden="true"></i> Runs <span id="runsNotif" class="badge"></span></a></li>
                    <li><a data-toggle="tab" href="#api"><i class="fa fa-code" aria-hidden="true"></i> API</a></li>
                    <li><a href="http://pirus.readthedocs.io/en/latest/?badge=latest" target="_blanck" style="color:#337ab7!important;"><i class="fa fa-question" aria-hidden="true"></i> Help</a></li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </nav>

    <div class="container theme-showcase" role="main">
        <h1 class="content-subhead hidden" style="margin-top:70px"><i class="fa fa-retweet" aria-hidden="true"></i> WS [ <span id="message"></span> ]</h1>
        <div class="tab-content" style="margin-top:70px">

            <!--          -->
            <!-- OVERVIEW -->
            <!--          -->
            <div id="overview" class="tab-pane fade in active">
                <!--
                <h1 class="content-subhead"><i class="fa fa-user" aria-hidden="true"></i> Online</h1>
                <ul id="userList"></ul>
                -->
                <div class="row">
                    <div class="col-md-4"><img src="/assets/img/resume.png" width="300px" /></div>
                    <div class="col-md-8">
                        <p style="margin-top: 130px;">Pirus is a tool that allow you to manage and run informatic's pipeline.</p>
                        <p>So there is 3 mains objects that you can manipulates :<ul>
                            <li>File</li>
                            <li>Pipeline</li>
                            <li>Run</li>
                        </ul>
                        <p>You can browse and manage each of theses objets via the 3 dedicated sections (see the top navigation bar).</p>
                    </div>
                </div>


                <h1 class="content-subhead"><i class="fa fa-user" aria-hidden="true"></i> Pirus browser</h1>

                <button type="button" class="btn btn-primary"><i class="fa fa-puzzle-piece" aria-hidden="true"></i> Install a new Pipeline</button>
                &nbsp; &nbsp;
                <button type="button" class="btn btn-primary"><i class="fa fa-upload" aria-hidden="true"></i> Upload an input's file</button>

                <div style="margin-top:20px;">
                    <table class="tree" style="width:100%">
                        <thead>
                            <tr>
                                <th>Run</th>
                                <th>Description</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="pirusBrowser">
                        </tbody>
                    </table>
                </div>
            </div>


            <!--       -->
            <!-- FILES -->
            <!--       -->
            <div id="files" class="tab-pane fade">
                <h1 class="content-subhead"><i class="fa fa-plus" aria-hidden="true"></i> Upload a file</h1>


                <div class="alert alert-warining hidden" id="support-alert">
                    <b>Warning!</b> Your browser does not seem to support the features necessary to run tus-js-client. The buttons below may work but probably will fail silently.
                </div>

                <input type="hidden" id="tusFileEndpoint" name="tusFileEndpoint" value="http://{{ hostname }}/file/upload">
                <input type="hidden" id="tusFileChunksize" name="tusFileChunksize" value="256000">
                <input type="file" id="tusFileInput">
                <br/>
                <div id="tusFileProgress">
                    <div class="alert alert-success" id="support-alert">
                        <b>Ready !</b> Start by selecting the file you want to upload. Upload will start automaticaly but you will be able to edit informations when you want.
                    </div>
                </div>


                <form id="uploadFileForm" method="PUT" enctype="multipart/form-data" action="http://{{ hostname }}/file" class="pure-form hidden">
                    <!--
                    <fieldset>
                        <div class="fileUpload btn btn-default">
                            <span><i class="fa fa-file-archive-o" aria-hidden="true"></i> Select a file</span>
                            <input type="file" name="uploadFile" id="uploadFile" class="upload" />
                        </div>
                    </fieldset>
                    -->
                    <fieldset>
                        <span><i aria-hidden="true"></i> Tags</span>
                        <input id="uploadFileFormTags" type="text" name="tags" placeholder="Optional tags (comma separated)" class="form-control"/>
                    </fieldset>
                    <fieldset>
                        <span><i aria-hidden="true"></i> Comments</span>
                        <input id="uploadFileFormComments" type="text" name="comments" placeholder="Optional comments" class="form-control"/>
                    </fieldset>
                    <input type="submit" value="Update file data" class="btn btn-primary btn btn-primary-primary"/>
                </form>

                <br/>



                <h1 class="content-subhead"><i class="fa fa-file-o" aria-hidden="true"></i> Files</h1>
                {% if files|length ==0 %}
                <div class="alert alert-warning" role="alert">
                    <strong>Warning!</strong> No file available on the server.
                </div>
                {% else %}
                <table id="filesList" class="table table-striped table-bordered" cellspacing="0" width="100%">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Tags</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>

                    {% for f in files %}
                    <tr id="fileEntry-{{ f["id"] }}">
                        <td>{{ f["name"] }}<br/><span class="details">{{ f["id"] }} - {{ f["size"] }}</span></td>
                        <td style="vertical-align: middle;">{{ f["tags"] }}</td>
                        <td style="vertical-align: middle;"><progress value="{{ f["upload_offset"] }}" max="{{ f["size"] }}" ></progress> {{ f["status"] }}</td>
                        <td style="vertical-align: middle;">
                            <div class="btn-group" role="group">
                                <a class="btn btn-default btn-xs disabled" title="Delete file" onclick="javascript:delete_file('{{f["id"]}}')"><i class="fa fa-trash" aria-hidden="true"> delete</i></a> 
                                <a class="btn btn-default btn-xs" title="Information about the file" href="http://{{ hostname }}/file/{{f["id"]}}" target="_blanck"><i class="fa fa-info" aria-hidden="true"> info</i></a> 
                                <a class="btn btn-default btn-xs" title="Download the file"          href="http://{{ hostname }}/dl/f/{{f["id"]}}" target="_blanck"><i class="fa fa-file" aria-hidden="true"> download</i></a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </table>
                {% endif %}
            </div>


            <!--           -->
            <!-- PIPELINES -->
            <!--           -->
            <div id="pipes" class="tab-pane fade">
                <h1 class="content-subhead"><i class="fa fa-plus" aria-hidden="true"></i> Install a new pipeline</h1>

                <input type="hidden" id="tusPipeEndpoint" name="tusPipeEndpoint" value="http://{{ hostname }}/pipeline/upload">
                <input type="hidden" id="tusPipeChunkSize" name="tusPipeChunkSize" value="256000">
                <input type="file" id="tusPipeInput">
                <br/>
                <div id="tusPipeProgress">
                    <div class="alert alert-success" id="support-alert">
                        <b>Ready !</b> Start by selecting the pipeline you want to install. Upload will start automaticaly.
                    </div>
                </div>

                <br/>


                <h1 class="content-subhead"><i class="fa fa-puzzle-piece" aria-hidden="true"></i> Pipelines</h1>

                {% if pipes|length ==0 %}
                <div class="alert alert-warning" role="alert">
                    <strong>Warning!</strong> No pipeline installed.
                </div>
                {% else %}
                <table id="pipesList" class="table table-striped table-bordered" cellspacing="0" width="100%">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    {% for p in pipes %}
                    <tr>
                    {% if p["status"] in ["UPLOADING", "PAUSE"] %}
                        <td style="vertical-align: middle;"><i class="fa fa-download" style="font-size: 30px; color:#337ab7;" aria-hidden="true"></i> &nbsp; {{ p["name"] }}</td>
                        <td style="vertical-align: middle;">Upload in progress</td>
                        <td style="vertical-align: middle;"><progress value="{{ p["upload_offset"] }}" max="{{ p["size"] }}" ></progress> {{ p["status"] }}</td> 
                        <td style="vertical-align: middle;">
                            <div class="btn-group" role="group">
                                <a class="btn btn-default btn-xs" title="Uninstall the pipeline package" onclick="javascript:delete_pipeline('{{p["id"]}}')"><i class="fa fa-trash" aria-hidden="true"></i></a> 
                                <a class="btn btn-default btn-xs" title="Information about the pipeline" href="http://{{ hostname }}/pipeline/{{p["id"]}}" target="_blanck"><i class="fa fa-info" aria-hidden="true"></i></a>
                            </div>
                        </td>
                    {% else %}
                        <td style="vertical-align: middle;"><img src="{{ p["icon_url"] }}" style="height:30px; width:30px; vertical-align:middle;"/> &nbsp; {{ p["name"] }} <i>({{ p["version"] }})</i></td>
                        <td style="vertical-align: middle;">{{ p["description"] }}</td>
                        <td style="vertical-align: middle;"><progress value="{{ p["upload_offset"] }}" max="{{ p["size"] }}" ></progress> {{ p["status"] }}</td> 
                        <td style="vertical-align: middle;">
                            <div class="btn-group" role="group">
                                <a class="btn btn-default btn-xs" title="Uninstall the pipeline package" onclick="javascript:delete_pipeline('{{p["id"]}}')"><i class="fa fa-trash" aria-hidden="true"></i></a> 
                                <a class="btn btn-default btn-xs" title="Information about the pipeline" href="http://{{ hostname }}/pipeline/{{p["id"]}}" target="_blanck"><i class="fa fa-info" aria-hidden="true"></i></a> 
                                <a class="btn btn-default btn-xs" title="Get Formular files information" href="{{p["form_url"]}}" target="_blanck"><i class="fa fa-file" aria-hidden="true"> form</i></a> 
                            </div>
                            &nbsp;
                            <a class="btn btn-success btn-xs" title="Run the pipeline" data-toggle="modal"  href="#runConfigModal" onclick="javascript:init_run('{{p["id"]}}')"><i class="fa fa-play" aria-hidden="true"></i></a>
                        </td>
                    {% endif %}
                    </tr>
                    {% endfor %}
                </table>
                {% endif %}

                
            </div>


            <!--      -->
            <!-- RUNS -->
            <!--      -->
            <div id="runs" class="tab-pane fade">
                <h1 class="content-subhead"><i class="fa fa-tasks" aria-hidden="true"></i> Runs</h1>
                {% if runs|length ==0 %}
                <div class="alert alert-warning" role="alert">
                    <strong>Warning!</strong> No run have been launched.
                </div>
                {% else %}
                <table id="runsList" class="table table-striped table-bordered" cellspacing="0" width="100%">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Progress</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    {% for r in runs %}
                    <tr>
                        <td>{{ r["name"] }}<br><span class="details">{{ r["id"] }}</span></td>
                        <td id="run-{{ r["id"] }}-progress" style="vertical-align: middle;">
                            <div class="progress">
                                <div class="progress-bar {% if r["status"] == "FAILLED" or r["status"] == "CANCELED" %}progress-bar-danger{% endif -%}{% if r["status"] == "RUN" %}progress-bar-striped active{% endif -%}{% if r["status"] == "DONE" %}progress-bar-success{% endif -%}{% if r["status"] == "WAITING" or r["status"] == "PAUSE" %}progress-bar-warning{% endif -%}" 
                                    role="progressbar" aria-valuenow="{{ r["progress"]["value"] }}" aria-valuemin="{{ r["progress"]["min"] }}" aria-valuemax="{{ r["progress"]["max"] }}" 
                                    style="min-width: 2em; width: {{ r["progress"]["value"] }}%;">
                                    {{ r["progress"]["value"] }} %
                                </div>
                            </div>
                        </td>
                        <td id="run-{{ r["id"] }}-status" style="vertical-align: middle;">{{ r["status"] }}</td>
                        <td style="vertical-align: middle;">
                            <div class="btn-group" role="group">
                                <a class="btn btn-default btn-xs" title="Information about the run" href="http://{{ hostname }}/run/{{r["id"]}}" target="_blanck"><i class="fa fa-info" aria-hidden="true"> info</i></a> 
                                <a class="btn btn-default btn-xs" title="Output log file" href="http://{{ hostname }}/run/{{r["id"]}}/out" target="_blanck"><i class="fa fa-file-text-o" aria-hidden="true"> log</i></a>
                                <a class="btn btn-default btn-xs" title="Error log file" href="http://{{ hostname }}/run/{{r["id"]}}/err" target="_blanck"><i class="fa fa-file-text-o" aria-hidden="true"> err</i></a>
                            </div>
                            &nbsp;
                            <div class="btn-group" role="group">
                                <a class="btn btn-default btn-xs" title="Browse input files" data-toggle="modal" href="#runBrowseFile" onclick="javascript:browse_io('{{r["id"]}}', 'inputs')">
                                    <i class="fa fa-folder-open-o" aria-hidden="true"> inputs</i></a> 
                                <a class="btn btn-default btn-xs" title="Browse output files" data-toggle="modal" href="#runBrowseFile" onclick="javascript:browse_io('{{r["id"]}}', 'outputs')">
                                    <i class="fa fa-folder-open-o" aria-hidden="true"> outputs</i></a> 
                            </div>
                            &nbsp;
                            <div class="btn-group" role="group">
                                <a class="btn btn-warning btn-xs {% if r["status"] in ["DONE", "ERROR", "CANCELED"] %}disabled{% endif -%}" title="Monitoring the run" href="#runMonitoring" onclick="javascript:monitor_run('{{r["id"]}}')" data-toggle="modal">
                                    <i class="fa fa-tachometer" aria-hidden="true"> Monitor</i></a>
                                <a class="btn btn-default btn-xs {% if r["status"] in ["DONE", "ERROR", "CANCELED"] %}disabled{% endif -%}" title="Cancel the run" href="http://{{ hostname }}/run/{{r["id"]}}/stop" target="_blanck">
                                    <i class="fa fa-stop" aria-hidden="true"></i></a> 
                                <a class="btn btn-default btn-xs {% if r["status"] in ["DONE", "ERROR", "CANCELED"] %}disabled{% endif -%}" title="Start the run" href="http://{{ hostname }}/run/{{r["id"]}}/play" target="_blanck">
                                    <i class="fa fa-play" aria-hidden="true"></i></a>
                                <a class="btn btn-default btn-xs {% if r["status"] in ["DONE", "ERROR", "CANCELED"] %}disabled{% endif -%}" title="Pause the run" href="http://{{ hostname }}/run/{{r["id"]}}/pause" target="_blanck">
                                    <i class="fa fa-pause" aria-hidden="true"></i></a>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            </table>
            {% endif %}
            </div>

            <!--     -->
            <!-- API -->
            <!--     -->
            <div id="api" class="tab-pane fade">
                <h1> Comming soon</h1>
                <a href="https://annuel.framapad.org/p/pirusAPI">Spec in progress</a>
            </div>

            <!--      -->
            <!-- HELP -->
            <!--      -->
            <div id="help" class="tab-pane fade">
                <h1> Comming soon</h1>
                <ul>
                    <li><a href="https://github.com/REGOVAR/Pirus/blob/master/examples/pipelines/PirusBasic/readme.md">Pipeline creation</a></li>
                    <li><a href="https://github.com/REGOVAR/Pirus/tree/master/docs">Doc</a></li>
                </ul>
            </div>






            <div class="modal fade" id="runBrowseFile" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title"><i class="fa fa-folder-open-o" aria-hidden="true"></i> Browse file </h4>
                        </div>
                        <div class="modal-body">
                            <p id="runBrowserContainer"></p>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div class="modal fade" id="runConfigModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title"><i class="fa fa-play" aria-hidden="true"></i> New <span id="newRunPipeName" class="text-primary"></span> run</h4>
                        </div>

                            <div class="tab-content" style="margin:0 10px;">
                                <div id="runConfigInputsTab" class="tab-pane fade in active">
                                    <div class="runConfigHeader">
                                        <p class="current"><span>1</span><br/><i class="fa fa-files-o" aria-hidden="true"></i> Inputs</p>
                                        <p class="sp"> • • • • </p>
                                        <p class=""><span>2</span><br/><i class="fa fa-cog" aria-hidden="true"></i> Configure</p>
                                        <p class="sp"> • • • • </p>
                                        <p class=""><span>3</span><br/><i class="fa fa-check" aria-hidden="true"></i> Confirm</p>
                                    </div>


                                    {% if files|length ==0 %}
                                    <div class="alert alert-warning" role="alert">
                                        <strong>Warning!</strong> No file available on the server. You can start by upload some file, or launch this run without inputs.
                                    </div>
                                    {% else %}
                                    <div class="runConfigTabDescription">Select the input files for the run</div>
                                    <table id="inputFilesList" class="table table-striped table-bordered" cellspacing="0" width="100%">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Infos</th>
                                            </tr>
                                        </thead>

                                        {% for f in files %}

                                        <tr id="inputEntry-{{ f["id"] }}">
                                            <td><input type="checkbox" value="{{ f["id"] }}" name="{% if f["source"]["type"] == "output" %}{{ f["source"]["run_name"] }} > {% endif %}{{ f["name"] }}"/> 
                                                {% if f["source"]["type"] == "output" %}
                                                    {{ f["source"]["run_name"] }} <i class="fa fa-chevron-right" aria-hidden="true"></i> 
                                                {% endif %}
                                                {{ f["name"] }} 
                                                {% if f["comments"] %}
                                                    <a href="#" data-toggle="tooltip" data-placement="right" title="{{f["comments"]}}"><i class="fa fa-info-circle" aria-hidden="true"></i></a>
                                                {% endif %}
                                                <br><span class="details">{% for t in f["tags"] %}{{t}} {% endfor %}</span></td>
                                            <td class="details">
                                                <progress value="{{ f["upload_offset"] }}" max="{{ f["size"] }}" ></progress> {{ f["size"] }}<br/>
                                                {{ f["create_date"]}}
                                                </td>
                                        </tr>
                                        {% endfor %}
                                    </table>
                                    <p style="margin-top: 20px; text-align:right;"> 
                                        <button type="button" class="btn btn-primary" data-toggle="tab" href="#runConfigFormTab" onclick="javascript:run_config_step_2();">Next &nbsp;<i class="fa fa-chevron-right" aria-hidden="true"></i></button>
                                    </p>
                                    {% endif %}
                                </div>
                                <div id="runConfigFormTab" class="tab-pane fade">
                                    <div class="runConfigHeader">
                                        <p class="ok"><span>1</span><br/><i class="fa fa-files-o" aria-hidden="true"></i> Inputs</p>
                                        <p class="sp ok"> ——————— </p>
                                        <p class="current"><span>2</span><br/><i class="fa fa-cog" aria-hidden="true"></i> Configure</p>
                                        <p class="sp"> • • • • </p>
                                        <p class="next"><span>3</span><br/><i class="fa fa-check" aria-hidden="true"></i> Confirm</p>
                                    </div>
                                    <div class="runConfigTabDescription">Configure the run</div>
                                    <div id="runConfigContainer"></div>
                                    <p style="margin-top: 20px; text-align:right;"> 
                                        <button type="button" class="btn btn-primary" data-toggle="tab" href="#runConfigInputsTab"><i class="fa fa-chevron-left" aria-hidden="true"></i>&nbsp; Previous</button> &nbsp; 
                                        <button type="button" class="btn btn-primary" data-toggle="tab" href="#runConfigConfirmTab">Next &nbsp;<i class="fa fa-chevron-right" aria-hidden="true"></i></button>
                                    </p>
                                </div>
                                <div id="runConfigConfirmTab" class="tab-pane fade">
                                    <div class="runConfigHeader">
                                        <p class="ok"><span>1</span><br/><i class="fa fa-files-o" aria-hidden="true"></i> Inputs</p>
                                        <p class="sp ok"> ——————— </p>
                                        <p class="ok"><span>2</span><br/><i class="fa fa-cog" aria-hidden="true"></i> Configure</p>
                                        <p class="sp ok"> ——————— </p>
                                        <p class="current"><span>3</span><br/><i class="fa fa-check" aria-hidden="true"></i> Confirm</p>
                                    </div>
                                    <div class="runConfigTabDescription"> The run is ready to start !</i></div>
                                    <div id="runConfirmContainer">
                                        <dl>
                                            <dt>Inputs </dt>
                                            <ll>file1</ll>
                                            <ll>file2</ll>
                                            <ll>file3</ll>

                                            <dt>Parameters</dt>
                                            <ll>Param1 : val 1</ll>
                                            <ll>Param2 : val 2</ll>
                                            <ll>Param3 : val 3</ll>
                                        </dl>
                                    </div>
                                    <p style="margin-top: 20px; text-align:center;"> 
                                        <button type="button" class="btn btn-primary" data-toggle="tab" href="#runConfigFormTab"><i class="fa fa-chevron-left" aria-hidden="true"></i>&nbsp; Previous</button>  &nbsp; 
                                        <button id="runConfirmButton" type="button" class="btn btn-success" onclick="javascript:run_config_step_3();"><i class="fa fa-check" aria-hidden="true"></i>&nbsp; Run !</button>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div class="modal fade" id="runMonitoring" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                <div class="modal-dialog" role="document">
                    <div class="modal-content" style="width: 1000px; margin-left: -200px;">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title"><i class="fa fa-tachometer" aria-hidden="true"></i> Monitoring <span id="runMonitoringName"> toto</span> </h4>
                        </div>
                        <div class="modal-body" id="runMonitoringContainer">
                            <nav class="navbar navbar-default" style="margin-top: -16px; margin-left: -15px; margin-right: -15px;">
                                <div class="container">
                                    <div id="navbar" class="navbar-collapse collapse" aria-expanded="false" style="height: 1px;">
                                        <ul class="nav navbar-nav">
                                            <li class="active"><a data-toggle="tab" href="#monitoringDetails"><i class="fa fa-tasks" aria-hidden="true"></i> Status</a></li>
                                            <li><a data-toggle="tab" href="#monitoringOutLog"><i class="fa fa-desktop" aria-hidden="true"></i> StdOut</a></li>
                                            <li><a data-toggle="tab" href="#monitoringErrLog"><i class="fa fa-desktop" aria-hidden="true"></i> StdErr</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </nav>
                            <div class="tab-content">
                                <div id="monitoringDetails" class="tab-pane fade in active">
                                    <p id="runMonitoringDetails"></p>
                                </div>
                                <div id="monitoringOutLog" class="tab-pane fade">
                                    <pre id="runMonitoringStdout"></pre>
                                </div>
                                <div id="monitoringErrLog" class="tab-pane fade">
                                    <pre id="runMonitoringStderr"></pre>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button id="runMonitoringRefreshBtn" type="button" class="btn btn-primary" ><i class="fa fa-refresh" aria-hidden="true"></i> Refresh</button> &nbsp;
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>


    <script src="/assets/pirus.js"></script>
    <script src="/assets/tus.js"></script>
    <script src="/assets/tus_client.js"></script>
    <script>
        var rootURL = "http://{{ hostname }}";

        var ws = new WebSocket('ws://{{ hostname }}/ws');
        var $message = $('#message');
        var BrutusinForms = brutusin["json-forms"];
        var bf, schema;

        var runConfigPipeId;
        var runConfigForm;
        var runConfigInputs;


        function run_config_step_2()
        {
            // Retrieve list of selected inputs
            runConfigInputs = {};
            $("#inputFilesList input:checked").each(function() 
            {
                runConfigInputs[$(this).attr("name")] = $(this).attr("value");
            });




            var json_files = []
            var json = runConfigForm
            if (json.indexOf("__PIRUS_INPUT_FILES__") != -1)
            {
                var i = 0;
                for (var key in runConfigInputs)
                {
                    json_files[i] = key;
                    i++;
                }
                
                json = json.replace(/"__PIRUS_INPUT_FILES__"/g, JSON.stringify(json_files))
            }


            
            schema = JSON.parse(json);
            schema["properties"]["name"] = {
                "title": "Nom du run",
                "description": "Le nom qui sera affiché pour ce run.",
                "type": "string",
                "required": true
            };
            
            bf = BrutusinForms.create(schema);
            var container = document.getElementById('runConfigContainer');
            container.innerText = ""
            bf.render(container, null);
        }


        function init_run(pipe_id)
        {
            // 1- retrieve pipe-config
            $.ajax(
            {
                url: rootURL + "/pipeline/" + pipe_id + "/form.json",
                type: "GET"
            }).fail(function()
            {
                alert( "ERROR" );
            }).done(function(json) 
            {
                var json_db = []

                if (json.indexOf("__PIRUS_DB_ALL__") != -1)
                {

                    // get list of database
                    $.ajax({ url: rootURL + "/db", type: "GET", async: false}).done(function(jsonDB)
                    {
                        json_db = jsonDB["data"];
                    })

                    json = json.replace(/"__PIRUS_DB_ALL__"/g, JSON.stringify(json_db))
                }
                runConfigForm = json;
                runConfigPipeId = pipe_id;
                
                run_config_step_2();
            })
        }

        function run_config_step_3()
        {
            if (bf.validate())
            {
                config = bf.getData()
                config = JSON.stringify(config, null, 4)
                inputs = []

                debugger;
                var i = 0;
                for (var key in runConfigInputs)
                {
                    inputs[i] = runConfigInputs[key];
                    config = config.replace(new RegExp(key, 'g'), runConfigInputs[key]);

                    i++;
                }

                inputs = JSON.stringify(inputs, null, 4)

                $.ajax(
                {
                    url: rootURL + "/run",
                    type: "POST",
                    data: "{\"pipeline_id\" : \""+ runConfigPipeId +"\", \"config\" : " + config + ", \"inputs\" : " + inputs + "}"
                }).fail(function()
                {
                    alert( "ERROR" );
                }).done(function(txt) 
                {
                    alert( "SUCCESS\n" + txt);
                })
            }
        }




        function monitor_run(run_id)
        {
            $("#runMonitoringName").text(run_id)
            $.ajax({ url: rootURL + "/run/" + run_id + "/monitoring", type: "GET", async: false}).done(function(jsonFile)
            {
                data = jsonFile["data"];
                $("#runMonitoringDetails").html("<ul><li>Processes : " + data["Processes"] + "</li><li>Memory (current) : " + data["Memory (current)"] + "</li></ul>")

                $("#runMonitoringStdout").text(data["out_tail"])
                $("#runMonitoringStdout").animate({scrollTop : $("#runMonitoringStdout")[0].scrollHeight }, 1000 );

                $("#runMonitoringStderr").text(data["err_tail"])
                $("#runMonitoringStderr").animate({scrollTop : $("#runMonitoringStderr")[0].scrollHeight}, 1000 );

                $("#runMonitoringRefreshBtn").attr("onclick", "javascript:monitor_run('"+run_id+"')")
            })
        }


        function browse_io(run_id, type)
        {
            $.ajax({ url: rootURL + "/run/" + run_id + "/io", type: "GET", async: false}).done(function(jsonFile)
            {
                data = jsonFile["data"];
                html = "<ul>"
                for (var i=0; i<data[type].length; i++)
                {
                   html += "<li><a href=\"" + rootURL + "/dl/f/" + data[type][i]["id"] + "\" title=\"Download\">" + data[type][i]["name"] + "</a> (" + humansize(data[type][i]["size"]) + ")</li>"
                }
                html += "</ul>"
                $("#runBrowserContainer").html(html)
            })
        }



        $( "#username" ).change(function()
        {
            ws.send( "{\"action\" : \"user_info\", \"data\" : { \"username\" : \"" + $( this ).val() + "\"}}" );
        });


        function delete_pipeline(pipe_id)
        {
            $.ajax(
            {
                url: rootURL + "/pipeline/" + pipe_id,
                type: "DELETE"
            }).fail(function()
            {
                alert( "ERROR" );
            }).done(function(txt) 
            {
                alert( "SUCCESS\n" + txt);
            })
        }
        


        $(document).ready(function()
        {
            update_datagrid();
            init_pirus_browser();
        });



        function update_datagrid()
        {
            $('#pipesList').DataTable();
            $('#runsList').DataTable();
            $('#filesList').DataTable();
            $('#inputFilesList').DataTable();
            $('[data-toggle="tooltip"]').tooltip(); 
        }

        function ws_new_pipeline(msg_data)
        {

        }

        function ws_new_run(msg_data)
        {

        }

        function ws_run_changed(data)
        {
            jQuery.each(data, function(index, item) {
                var percentage = (item["progress"]["value"] / item["progress"]["max"] * 100).toFixed(2)
                buildProgressBar(percentage, item["status"], "run-" + item["id"] + "-progress")
                var tdElement = $("#run-" + item["id"] + "-status")
                tdElement.html(item["status"])
            });
            // Todo : update controls
        }



        ws.onopen = function()
        {
            $message.attr("class", 'label label-success');
            $message.text('open');

            ws.send('{"action" : "authent", "data" : "Chrome"}')
        };
        ws.onmessage = function(ev)
        {
            $message.attr("class", 'label label-info');
            var json = JSON.parse(ev.data);

            dt = new Date()
            $message.html(dt.toLocaleTimeString() + ' ' + json["action"] + ' : ' + json["data"]);


            switch(json["action"])
            {
                case 'online_user':
                var uTxt = ""
                $.each(json["data"], function (idx, val)
                {
                    uTxt += "<li>" + val + "</li>"
                })
                $('#userList').html(uTxt)
                break;

                case 'run_changed':

                ws_run_changed(json["data"])
                break;

                // Todo
                // - PipeLst_update
            }
        };
        ws.onclose = function(ev)
        {
            $message.attr("class", 'label label-important');
            $message.text('closed');
        };
        ws.onerror = function(ev)
        {
            $message.attr("class", 'label label-warning');
            $message.text('error occurred');
        };
    </script>
</body>
</html> 
